<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚ ì”¨ ê¸°ë°˜ ìŒì‹ ì¶”ì²œ & ì§€ë„ (SPA)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial; }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
    .layout {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    /* ì¢Œì¸¡ íŒ¨ë„ */
    .sidebar {
        width: 350px;
        background: #f5f5f7;
        padding: 20px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }

    .sidebar h2 { margin-top:0; }

    input, button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
    }

    button {
        background: #2f80ed;
        border: none;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }
    button:hover { background: #1d5fcc; }

    .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 20px;
    }

    .title-small {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 16px;
    }

    /* ìš°ì¸¡ ì§€ë„ */
    #map {
        flex-grow: 1;
        height: 100vh;
    }
</style>
</head>

<body>
<div class="layout">

    <!-- ì™¼ìª½ íŒ¨ë„ -->
    <div class="sidebar">
        <h2>ğŸ½ ë‚ ì”¨ ê¸°ë°˜ ìŒì‹ ì¶”ì²œ</h2>

        <input id="locationInput" placeholder="ì˜ˆ: ì„œìš¸, ë¶€ì‚°, New York">
        <button onclick="loadAll()">ì¡°íšŒí•˜ê¸°</button>

        <div id="weatherCard" class="card" style="display:none;">
            <div class="title-small">ğŸŒ¤ í˜„ì¬ ë‚ ì”¨</div>
            ê¸°ì˜¨: <span id="temp"></span>Â°C<br>
            êµ¬ë¦„: <span id="cloud"></span>%<br>
            ê°•ìˆ˜ëŸ‰: <span id="rain"></span> mm<br>
            ìŠµë„: <span id="humidity"></span>%<br>
        </div>

        <div id="foodCard" class="card" style="display:none;">
            <div class="title-small">ğŸœ ì¶”ì²œ ìŒì‹</div>
            <p id="foodText"></p>
        </div>

        <div id="listCard" class="card" style="display:none;">
            <div class="title-small">ğŸ½ ì£¼ë³€ ìŒì‹ì </div>
            <ul id="foodList"></ul>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

</div>

<!-- JS ì˜ì—­ -->

<script>
let map;
let markers = [];

/* -----------------------------
   1) ì§€ì—­ ì´ë¦„ â†’ ì¢Œí‘œ ë³€í™˜
--------------------------------*/
async function geocode(location) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${location}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.length) throw "í•´ë‹¹ ì§€ì—­ì˜ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
}

/* -----------------------------
   2) ë‚ ì”¨ API (ë°ëª¨ ë°ì´í„°)
   ì‹¤ì œ API ì‚¬ìš© ì›í•˜ë©´ ë§Œë“¤ì–´ì¤Œ
--------------------------------*/
async function loadWeather(lat, lon) {
    return {
        temp: 15,
        cloud: 60,
        rain: 0,
        humidity: 55
    };
}

/* -----------------------------
   3) ì¶”ì²œ ìŒì‹ ë¡œì§
--------------------------------*/
function recommendFood(w) {
    if (w.temp < 10) return "ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬: ì „ê³¨, ë¼ë©˜, ìš°ë™";
    if (w.rain > 1) return "ë¹„ ì˜¤ëŠ” ë‚ ì—” íŒŒì „ + ë§‰ê±¸ë¦¬!";
    if (w.cloud > 70) return "ë“ ë“ í•œ ìŒì‹: ì¹´ë ˆ, ì°œë‹­";
    return "ê°€ë³ê³  ì‚°ëœ»í•œ ìŒì‹: ì´ˆë°¥, ìƒëŸ¬ë“œ";
}

/* -----------------------------
   4) ì£¼ë³€ ìŒì‹ì  (Overpass API)
--------------------------------*/
async function loadRestaurants(lat, lon) {
    const query = `
        [out:json];
        node["amenity"="restaurant"](around:1500, ${lat}, ${lon});
        out;
    `;
    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    });
    const data = await res.json();
    return data.elements;
}

/* -----------------------------
   5) ì§€ë„ ì…‹ì—… + ë§ˆì»¤ í‘œì‹œ
--------------------------------*/
function renderMap(lat, lon, restaurants) {
    // ì´ˆê¸° 1íšŒ ìƒì„±
    if (!map) {
        map = L.map('map').setView([lat, lon], 14);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    } else {
        map.setView([lat, lon], 14);
    }

    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    // ê¸°ì¤€ì  ë§ˆì»¤
    const baseMarker = L.marker([lat, lon]).addTo(map).bindPopup("ê¸°ì¤€ ìœ„ì¹˜");
    markers.push(baseMarker);

    // ìŒì‹ì  ë§ˆì»¤
    restaurants.forEach(r => {
        const marker = L.marker([r.lat, r.lon]).addTo(map)
            .bindPopup(r.tags.name || "ì´ë¦„ ì—†ìŒ");
        markers.push(marker);
    });
}

/* -----------------------------
   6) ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰
--------------------------------*/
async function loadAll() {
    try {
        const loc = document.getElementById("locationInput").value;
        if (!loc) return alert("ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”!");

        const [lat, lon] = await geocode(loc);
        const weather = await loadWeather(lat, lon);

        // ë‚ ì”¨ í‘œì‹œ
        document.getElementById("temp").textContent = weather.temp;
        document.getElementById("cloud").textContent = weather.cloud;
        document.getElementById("rain").textContent = weather.rain;
        document.getElementById("humidity").textContent = weather.humidity;
        document.getElementById("weatherCard").style.display = "block";

        // ìŒì‹ ì¶”ì²œ
        const food = recommendFood(weather);
        document.getElementById("foodText").textContent = food;
        document.getElementById("foodCard").style.display = "block";

        // ìŒì‹ì  ê²€ìƒ‰
        const restaurants = await loadRestaurants(lat, lon);

        // ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        const ul = document.getElementById("foodList");
        ul.innerHTML = "";
        restaurants.forEach(r => {
            const name = r.tags.name || "ì´ë¦„ ì—†ìŒ";
            ul.innerHTML += `<li>${name}</li>`;
        });
        document.getElementById("listCard").style.display = "block";

        // ì§€ë„ í‘œì‹œ
        renderMap(lat, lon, restaurants);

    } catch (e) {
        alert("ì˜¤ë¥˜: " + e);
    }
}
</script>
</body>
</html>