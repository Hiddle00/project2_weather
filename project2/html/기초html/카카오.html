<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚ ì”¨ ê¸°ë°˜ ìŒì‹ ì¶”ì²œ & ì§€ë„ (SPA)</title>

<!-- Kakao Maps API -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=REMOVED"></script>

<style>
* { box-sizing: border-box; }
body { margin: 0; font-family: Arial; }

/* ì „ì²´ ë ˆì´ì•„ì›ƒ */
.layout { display: flex; height: 100vh; width: 100vw; }

/* ì¢Œì¸¡ íŒ¨ë„ */
.sidebar { width: 350px; background: #f5f5f7; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; }
.sidebar h2 { margin-top:0; }
input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; }
button { background: #2f80ed; border: none; color: white; cursor: pointer; font-weight: bold; }
button:hover { background: #1d5fcc; }
.card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ccc; margin-top: 20px; }
.title-small { font-weight: bold; margin-bottom: 10px; font-size: 16px; }

/* ìš°ì¸¡ ì§€ë„ */
#map { flex-grow: 1; height: 100vh; }
</style>
</head>

<body>
<div class="layout">

    <!-- ì™¼ìª½ íŒ¨ë„ -->
    <div class="sidebar">
        <h2><img src="emoji.png" height="30px" width="30px"> EZEN ë­ ë¨¹ì§€?</h2>

        <input id="locationInput" name="locationInput" placeholder="ì˜ˆ: OOë™ or ìŒì‹ì  ì´ë¦„">
        <button onclick="loadAll()">ì¡°íšŒí•˜ê¸°</button>

        <div id="weatherCard" class="card" style="display:none;">
            <div class="title-small">ğŸŒ¤ í˜„ì¬ ë‚ ì”¨</div>
            ê¸°ì˜¨: <span id="temp"></span>Â°C<br>
            êµ¬ë¦„: <span id="cloud"></span>%<br>
            ê°•ìˆ˜ëŸ‰: <span id="rain"></span> mm<br>
            ìŠµë„: <span id="humidity"></span>%<br>
        </div>

        <div id="foodCard" class="card" style="display:none;">
            <div class="title-small">ğŸœ ì¶”ì²œ ìŒì‹</div>
            <p id="foodText"></p>
        </div>

        <div id="listCard" class="card" style="display:none;">
            <div class="title-small">ğŸ½ ì£¼ë³€ ìŒì‹ì </div>
            <ul id="foodList"></ul>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

</div>

<script>
let map;
let markers = [];

/* -----------------------------
   1) ë¸Œë¼ìš°ì € ìœ„ì¹˜ ì •ë³´ ìš”ì²­
--------------------------------*/
function getUserLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                resolve([lat, lon]);
            },
            (err) => {
                reject("ìœ„ì¹˜ ì •ë³´ í—ˆìš©ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.");
            }
        );
    });
}

/* -----------------------------
   2) ê¸°ìƒì²­ ë‹¨ê¸°ì˜ˆë³´ API í˜¸ì¶œ (ìˆ˜ì •ë³¸)
--------------------------------*/
async function loadWeather(lat, lon) {
    // 1) ê²©ì ì¢Œí‘œ ë³€í™˜
    const { x: nx, y: ny } = dfsXyConv(lat, lon);

    // 2) í˜„ì¬ ì‹œê° ê¸°ì¤€ baseDate, baseTime ê³„ì‚°
    const now = new Date();
    let baseDate = new Date(now);
    let hh = now.getHours();
    let mm = now.getMinutes();

    // í˜„ì¬ ë¶„ì´ 40ë¶„ ì´ì „ì´ë©´, ì´ì „ ì‹œê° ê¸°ì¤€
    if (mm < 40) {
        hh -= 1;
        if (hh < 0) {
            hh = 23;
            baseDate.setDate(baseDate.getDate() - 1); // ì „ë‚ ë¡œ ì´ë™
        }
    }

    const baseDateStr = baseDate.toISOString().slice(0,10).replace(/-/g,""); // YYYYMMDD
    const baseTime = String(hh).padStart(2,"0") + "00"; // HH00

    // 3) ì„œë¹„ìŠ¤í‚¤ ì…ë ¥
    const serviceKey = "REMOVED";

    const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst?` +
                `serviceKey=${serviceKey}&numOfRows=100&pageNo=1&dataType=JSON&base_date=${baseDateStr}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;

    try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.response || !data.response.body || !data.response.body.items) {
            throw new Error("API ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜");
        }

        const items = data.response.body.items.item;
        let weather = { temp:"-", cloud:"-", rain:"-", humidity:"-" };

        items.forEach(it => {
            switch(it.category){
                case "T1H": weather.temp = it.obsrValue; break;      // ê¸°ì˜¨
                case "RN1": weather.rain = it.obsrValue; break;      // 1ì‹œê°„ ê°•ìˆ˜ëŸ‰
                case "REH": weather.humidity = it.obsrValue; break;  // ìŠµë„
                case "SKY": weather.cloud = it.obsrValue; break;     // í•˜ëŠ˜ ìƒíƒœ 1~4 (1=ë§‘ìŒ, 4=íë¦¼)
            }
        });

        // í•˜ëŠ˜ ìƒíƒœë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
        if(weather.cloud !== "-") {
            weather.cloud = (weather.cloud/4*100).toFixed(0);
        }

        return weather;

    } catch(e) {
        console.error("ê¸°ìƒì²­ API ì˜¤ë¥˜:", e);
        return { temp:"-", cloud:"-", rain:"-", humidity:"-" };
    }
}


/* -----------------------------
   3) ì¶”ì²œ ìŒì‹ ë¡œì§
--------------------------------*/
function recommendFood(w) {
    if (w.temp < 10) return "ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬: ì „ê³¨, ë¼ë©˜, ìš°ë™";
    if (w.rain > 1) return "ë¹„ ì˜¤ëŠ” ë‚ ì—” íŒŒì „ + ë§‰ê±¸ë¦¬!";
    if (w.cloud > 70) return "ë“ ë“ í•œ ìŒì‹: ì¹´ë ˆ, ì°œë‹­";
    return "ê°€ë³ê³  ì‚°ëœ»í•œ ìŒì‹: ì´ˆë°¥, ìƒëŸ¬ë“œ";
}

/* -----------------------------
   4) ì£¼ë³€ ìŒì‹ì  (Overpass API)
--------------------------------*/
async function loadRestaurants(lat, lon) {
    const query = `
        [out:json];
        node["amenity"="restaurant"](around:1500, ${lat}, ${lon});
        out;
    `;
    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    });
    const data = await res.json();
    return data.elements;
}

/* -----------------------------
   5) ì¹´ì¹´ì˜¤ ì§€ë„ í‘œì‹œ
--------------------------------*/
function renderMap(lat, lon, restaurants) {
    const center = new kakao.maps.LatLng(lat, lon);

    if (!map) {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: center,
            level: 4
        });
    } else {
        map.setCenter(center);
    }

    markers.forEach(m => m.setMap(null));
    markers = [];

    const userMarker = new kakao.maps.Marker({ position: center, map: map });
    const baseInfo = new kakao.maps.InfoWindow({ content: "<div style='padding:5px;'>ğŸ“ ë‚´ ìœ„ì¹˜</div>" });
    baseInfo.open(map, userMarker);
    markers.push(userMarker);

    restaurants.forEach(r => {
        const pos = new kakao.maps.LatLng(r.lat, r.lon);
        const marker = new kakao.maps.Marker({ position: pos, map: map });
        const name = r.tags.name || "ì´ë¦„ ì—†ìŒ";
        const info = new kakao.maps.InfoWindow({ content: `<div style='padding:5px;'>${name}</div>` });
        kakao.maps.event.addListener(marker, 'click', () => { info.open(map, marker); });
        markers.push(marker);
    });
}

/* -----------------------------
   6) ì „ì²´ ì‹¤í–‰
--------------------------------*/
async function loadAll() {
    try {
        const [lat, lon] = await getUserLocation();

        const weather = await loadWeather(lat, lon);

        document.getElementById("temp").textContent = weather.temp;
        document.getElementById("cloud").textContent = weather.cloud;
        document.getElementById("rain").textContent = weather.rain;
        document.getElementById("humidity").textContent = weather.humidity;
        document.getElementById("weatherCard").style.display = "block";

        const food = recommendFood(weather);
        document.getElementById("foodText").textContent = food;
        document.getElementById("foodCard").style.display = "block";

        const restaurants = await loadRestaurants(lat, lon);
        const ul = document.getElementById("foodList");
        ul.innerHTML = "";
        restaurants.forEach(r => {
            const name = r.tags.name || "ì´ë¦„ ì—†ìŒ";
            ul.innerHTML += `<li>${name}</li>`;
        });
        document.getElementById("listCard").style.display = "block";

        renderMap(lat, lon, restaurants);

    } catch(e) {
        alert("ì˜¤ë¥˜: " + e);
    }
}

/* ------------------ ìœ„ê²½ë„â†’ê²©ì ë³€í™˜ í•¨ìˆ˜ ------------------ */
function dfsXyConv(lat, lon) {
    const RE = 6371.00877;
    const GRID = 5.0;
    const SLAT1 = 30.0;
    const SLAT2 = 60.0;
    const OLON = 126.0;
    const OLAT = 38.0;
    const XO = 43;
    const YO = 136;

    const DEGRAD = Math.PI / 180.0;

    let re = RE / GRID;
    let slat1 = SLAT1 * DEGRAD;
    let slat2 = SLAT2 * DEGRAD;
    let olon = OLON * DEGRAD;
    let olat = OLAT * DEGRAD;

    let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
    sn = Math.log(Math.cos(slat1)/Math.cos(slat2))/Math.log(sn);

    let sf = Math.tan(Math.PI*0.25+slat1*0.5);
    sf = Math.pow(sf,sn)*Math.cos(slat1)/sn;

    let ro = Math.tan(Math.PI*0.25+olat*0.5);
    ro = re*sf/Math.pow(ro,sn);

    let ra = Math.tan(Math.PI*0.25+lat*DEGRAD*0.5);
    ra = re*sf/Math.pow(ra,sn);

    let theta = lon*DEGRAD - olon;
    if(theta>Math.PI) theta-=2.0*Math.PI;
    if(theta<-Math.PI) theta+=2.0*Math.PI;
    theta*=sn;

    return {
        x: Math.floor(ra*Math.sin(theta)+XO+0.5),
        y: Math.floor(ro-ra*Math.cos(theta)+YO+0.5)
    };
}
</script>

</body>
</html>
