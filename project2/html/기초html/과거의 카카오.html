<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚ ì”¨ ê¸°ë°˜ ìŒì‹ ì¶”ì²œ & ì§€ë„ (SPA)</title>

<!-- Kakao Maps API (ì—¬ê¸°ì— ë³¸ì¸ í‚¤ ë„£ê¸°) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=REMOVED"></script>

<style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial; }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
    .layout {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    /* ì¢Œì¸¡ íŒ¨ë„ */
    .sidebar {
        width: 350px;
        background: #f5f5f7;
        padding: 20px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
    }

    .sidebar h2 { margin-top:0; }

    input, button {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
    }

    button {
        background: #2f80ed;
        border: none;
        color: white;
        cursor: pointer;
        font-weight: bold;
    }
    button:hover { background: #1d5fcc; }

    .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 20px;
    }

    .title-small {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 16px;
    }

    /* ìš°ì¸¡ ì§€ë„ */
    #map {
        flex-grow: 1;
        height: 100vh;
    }
</style>
</head>

<body>
<div class="layout">

    <!-- ì™¼ìª½ íŒ¨ë„ -->
    <div class="sidebar">
        <h2><img src="emoji.png" height="30px" width="30px"> EZEN ë­ ë¨¹ì§€?</h2>

        <input id="locationInput" name="locationInput" placeholder="ì˜ˆ: ì„œìš¸, ë¶€ì‚°, New York">
        <button onclick="loadAll()">ì¡°íšŒí•˜ê¸°</button>

        <div id="weatherCard" class="card" style="display:none;">
            <div class="title-small">ğŸŒ¤ í˜„ì¬ ë‚ ì”¨</div>
            ê¸°ì˜¨: <span id="temp"></span>Â°C<br>
            êµ¬ë¦„: <span id="cloud"></span>%<br>
            ê°•ìˆ˜ëŸ‰: <span id="rain"></span> mm<br>
            ìŠµë„: <span id="humidity"></span>%<br>
        </div>

        <div id="foodCard" class="card" style="display:none;">
            <div class="title-small">ğŸœ ì¶”ì²œ ìŒì‹</div>
            <p id="foodText"></p>
        </div>

        <div id="listCard" class="card" style="display:none;">
            <div class="title-small">ğŸ½ ì£¼ë³€ ìŒì‹ì </div>
            <ul id="foodList"></ul>
        </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

</div>

<!-- JS ì˜ì—­ -->

<script>
let map;
let markers = [];

/* -----------------------------
   1) ë¸Œë¼ìš°ì € ìœ„ì¹˜ ì •ë³´ ìš”ì²­
--------------------------------*/
function getUserLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                resolve([lat, lon]);
            },
            (err) => {
                reject("ìœ„ì¹˜ ì •ë³´ í—ˆìš©ì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.");
            }
        );
    });
}

/* -----------------------------
   2) ë‚ ì”¨ API (ì˜ˆì‹œ)
--------------------------------*/
async function loadWeather(lat, lon) {
    return {
        temp: 15,
        cloud: 60,
        rain: 0,
        humidity: 55
    };
}

/* -----------------------------
   3) ì¶”ì²œ ìŒì‹ ë¡œì§
--------------------------------*/
function recommendFood(w) {
    if (w.temp < 10) return "ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬: ì „ê³¨, ë¼ë©˜, ìš°ë™";
    if (w.rain > 1) return "ë¹„ ì˜¤ëŠ” ë‚ ì—” íŒŒì „ + ë§‰ê±¸ë¦¬!";
    if (w.cloud > 70) return "ë“ ë“ í•œ ìŒì‹: ì¹´ë ˆ, ì°œë‹­";
    return "ê°€ë³ê³  ì‚°ëœ»í•œ ìŒì‹: ì´ˆë°¥, ìƒëŸ¬ë“œ";
}

/* -----------------------------
   4) ì£¼ë³€ ìŒì‹ì  (Overpass API)
--------------------------------*/
async function loadRestaurants(lat, lon) {
    const query = `
        [out:json];
        node["amenity"="restaurant"](around:1500, ${lat}, ${lon});
        out;
    `;
    const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
    });
    const data = await res.json();
    return data.elements;
}

/* -----------------------------
   5) ì¹´ì¹´ì˜¤ ì§€ë„ í‘œì‹œ
--------------------------------*/
function renderMap(lat, lon, restaurants) {

    const center = new kakao.maps.LatLng(lat, lon);

    if (!map) {
        map = new kakao.maps.Map(document.getElementById('map'), {
            center: center,
            level: 4
        });
    } else {
        map.setCenter(center);
    }

    markers.forEach(m => m.setMap(null));
    markers = [];

    // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤
    const userMarker = new kakao.maps.Marker({
        position: center,
        map: map
    });

    const baseInfo = new kakao.maps.InfoWindow({
        content: "<div style='padding:5px;'>ğŸ“ ë‚´ ìœ„ì¹˜</div>"
    });
    baseInfo.open(map, userMarker);
    markers.push(userMarker);

    // ìŒì‹ì  ë§ˆì»¤
    restaurants.forEach(r => {
        const pos = new kakao.maps.LatLng(r.lat, r.lon);
        
        const marker = new kakao.maps.Marker({
            position: pos,
            map: map
        });

        const name = r.tags.name || "ì´ë¦„ ì—†ìŒ";

        const info = new kakao.maps.InfoWindow({
            content: `<div style='padding:5px;'>${name}</div>`
        });

        kakao.maps.event.addListener(marker, 'click', () => {
            info.open(map, marker);
        });

        markers.push(marker);
    });
}

/* -----------------------------
   6) ì „ì²´ ì‹¤í–‰
--------------------------------*/
async function loadAll() {
    try {
        // ì‚¬ìš©ì ìœ„ì¹˜ ìš”ì²­
        const [lat, lon] = await getUserLocation();

        // ë‚ ì”¨
        const weather = await loadWeather(lat, lon);

        document.getElementById("temp").textContent = weather.temp;
        document.getElementById("cloud").textContent = weather.cloud;
        document.getElementById("rain").textContent = weather.rain;
        document.getElementById("humidity").textContent = weather.humidity;
        document.getElementById("weatherCard").style.display = "block";

        // ìŒì‹ ì¶”ì²œ
        const food = recommendFood(weather);
        document.getElementById("foodText").textContent = food;
        document.getElementById("foodCard").style.display = "block";

        // ì£¼ë³€ ìŒì‹ì 
        const restaurants = await loadRestaurants(lat, lon);

        // ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        const ul = document.getElementById("foodList");
        ul.innerHTML = "";
        restaurants.forEach(r => {
            const name = r.tags.name || "ì´ë¦„ ì—†ìŒ";
            ul.innerHTML += `<li>${name}</li>`;
        });
        document.getElementById("listCard").style.display = "block";

        // ì§€ë„ í‘œì‹œ
        renderMap(lat, lon, restaurants);

    } catch (e) {
        alert("ì˜¤ë¥˜: " + e);
    }
}
</script>

</body>
</html>
