<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚ ì”¨ ê¸°ë°˜ ìŒì‹ ì¶”ì²œ & ì§€ë„ (SPA)</title>

<!-- Kakao Maps API -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=13a7c79d6744c966b6143c018bc02957"></script>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="layout">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œ -->
    <div class="sidebar">

        <!-- íƒ€ì´í‹€  -->
        <h2><img src="icons/emoji.png" height="30px" width="30px"> EZEN ë­ ë¨¹ì§€?</h2>

        <!-- ê²€ìƒ‰ ì…ë ¥ -->
        <input id="locationInput" name="locationInput" placeholder="ì˜ˆ: OOë™ or ìŒì‹ì  ì´ë¦„">

        <!-- ë²„íŠ¼ëˆ„ë¥´ë©´ loadAllí•¨ìˆ˜ ì‹¤í–‰ -->
        <button onclick="loadAll()">ì¡°íšŒí•˜ê¸°</button>

        <!-- ë‚ ì”¨ ì˜ì—­ -->
        <div id="weatherCard" class="weather-card" style="display:none;">

            <img class="weather-bg-icon" id="weatherBgIcon" src="icons/sun.png">
            <h3>í˜„ì¬ ë‚ ì”¨</h3>
            <div class="weather-main">
                <img id="weatherIcon" class="weather-icon" src="icons/sun.png">
                <div class="temp"><span id="temp"></span>Â°C</div>
            </div>

            <!-- ê¸°ìƒì²­apiì—ì„œ ë°›ì•„ì˜¨ ê°’ ì¶œë ¥ -->
            <div class="weather-details">
                <div class="weather-detail">
                    <span id="cloud"></span>%<small>êµ¬ë¦„ëŸ‰</small>
                </div>
                <div class="weather-detail">
                    <span id="rain"></span>mm<small>ê°•ìˆ˜ëŸ‰</small>
                </div>
                <div class="weather-detail">
                    <span id="humidity"></span>%<small>ìŠµë„</small>
                </div>
            </div>
        </div>
    <!-- ì¶”ì²œ ìŒì‹ ì¹´ë“œ -->
        <div id="foodCard" class="card" style="display:none;">
            <div class="title-small">ğŸœ ì¶”ì²œ ìŒì‹</div>
            <p id="foodText"></p>
        </div>
    <!-- ì¶”ì²œ ìŒì‹ì  ëª©ë¡ -->
        <div id="listCard" class="card" style="display:none;">
            <div class="title-small">ğŸ½ ì£¼ë³€ ìŒì‹ì </div>
            <ul id="foodList"></ul>
        </div>
    </div>
    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>
</div>

<!-- í”Œë¡œíŒ… íŒ¨ë„ -->
<div class="floating-panel" id="floatingPanel">
    <button class="close-btn" onclick="closePanel()">Ã—</button>
    <h4>ì¶”ì²œ ìŒì‹</h4>
    <div id="flotmenu"></div>
</div>


<script>
let map;
let markers = [];

// ì‚¬ìš©ì ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ê³¼ ë™ì¼)
async function getUserLocation() {
    return new Promise((resolve) => {
        // ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ë©´ ì „ì£¼ ì‹œì²­ìœ¼ë¡œ ê¸°ë³¸ê°’ ì§€ì •
        if (!navigator.geolocation) resolve({lat:35.8242, lon:127.1480});
        // ê±°ë¶€í•˜ë©´ ì „ì£¼ì‹œì²­ìœ¼ë¡œ ê¸°ë³¸ê°’ ì§€ì •
        else navigator.geolocation.getCurrentPosition(
            pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
            err => resolve({lat:35.8242, lon:127.1480})
        );
    });
}

// ê¸°ìƒì²­ì—ì„œ ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ê¸° (ê¸°ì¡´ê³¼ ë™ì¼)
async function loadWeather(lat, lon) {
    const { x: nx, y: ny } = dfsXyConv(lat, lon);
    const now = new Date();
    let baseDate = new Date(now);
    let hh = now.getHours();
    let mm = now.getMinutes();
    if (mm < 40) { hh -= 1; if(hh<0){ hh=23; baseDate.setDate(baseDate.getDate()-1); } }
    const baseDateStr = baseDate.toISOString().slice(0,10).replace(/-/g,"");
    const baseTime = String(hh).padStart(2,"0") + "00";
    const serviceKey = "4e27024dbae820c5f2095321a677edb4c33c68bca0b1914488bde4db4fe5ed48";   // api key
    const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst?serviceKey=${serviceKey}&numOfRows=100&pageNo=1&dataType=JSON&base_date=${baseDateStr}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        const items = data.response.body.items.item;
        let weather={ temp:"-", cloud:"-", rain:"-", humidity:"-", pty:0, sky:1 };
        items.forEach(it => { switch(it.category){
            case "T1H": weather.temp=it.obsrValue; break;
            case "RN1": weather.rain=it.obsrValue; break;
            case "REH": weather.humidity=it.obsrValue; break;
            case "SKY": weather.sky=it.obsrValue; break;
            case "PTY": weather.pty=it.obsrValue; break;
        }});
        if(weather.sky!="-") weather.cloud=(weather.sky/4*100).toFixed(0);
        const iconName = getWeatherIcon(weather.pty, weather.sky, weather.cloud, weather.rain);
        document.getElementById("weatherIcon").src = iconName;
        document.getElementById("weatherBgIcon").src = iconName;
        return weather;
    } catch(e) { console.error(e); return { temp:"-", cloud:"-", rain:"-", humidity:"-" }; }
}

// ê°„ë‹¨ ìŒì‹ ì¶”ì²œ (ê¸°ì¡´ê³¼ ë™ì¼)
function recommendFood(w){
    if(w.temp<10) return "ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬: ì „ê³¨, ë¼ë©˜, ìš°ë™";
    if(w.rain>1) return "ë¹„ ì˜¤ëŠ” ë‚ ì—” íŒŒì „ + ë§‰ê±¸ë¦¬!";
    if(w.cloud>70) return "ë“ ë“ í•œ ìŒì‹: ì¹´ë ˆ, ì°œë‹­";
    return "ê°€ë³ê³  ì‚°ëœ»í•œ ìŒì‹: ì´ˆë°¥, ìƒëŸ¬ë“œ";
}

// âš ï¸ ìˆ˜ì •: ìŒì‹ì  ë”ë¯¸ ë°ì´í„°ì— ì†Œë¶„ë¥˜, ì£¼ì†Œ ì •ë³´ ì¶”ê°€
async function loadRestaurants(lat, lon){
    // *******************************************************************
    // ì£¼ì˜: ì‹¤ì œ ë°±ì—”ë“œ API (`http://127.0.0.1:5000/restaurants`)ê°€
    // ìŒì‹ ì†Œë¶„ë¥˜, ì£¼ì†Œ ì •ë³´ë¥¼ ë°˜í™˜í•˜ë„ë¡ ìˆ˜ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    // í˜„ì¬ëŠ” API í˜¸ì¶œ í›„ í•˜ë“œì½”ë”©ëœ ë”ë¯¸ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •í•©ë‹ˆë‹¤.
    // *******************************************************************
    try{
        // ë°±ì—”ë“œ API í˜¸ì¶œì€ ìœ ì§€
        // const res = await fetch("http://127.0.0.1:5000/restaurants");
        // const data = await res.json();

        // ì„ì‹œ ë”ë¯¸ ë°ì´í„° (ì£¼ì†Œ ì •ë³´ í¬í•¨)
        const dummyData = [
            { r_name: "ê°€ë§ˆì†¥ ì„¤ë íƒ•", y: 35.820, x: 127.140, category: "í•œì‹", address: "ì „ì£¼ì‹œ ì™„ì‚°êµ¬ íŒ”ë‹¬ë¡œ 123", jibun: "ê°ì‚¬1ê°€ 12-3" },
            { r_name: "ë¯¸ë¯¸ ì§œì¥ë©´", y: 35.825, x: 127.155, category: "ì¤‘ì‹", address: "ì „ì£¼ì‹œ ì™„ì‚°êµ¬ ê°ì‚¬3ê¸¸ 45", jibun: "ê²½ì›ë™3ê°€ 45-1" },
            { r_name: "ìŠ¤ì‹œ ì˜¤ë§ˆì¹´ì„¸", y: 35.828, x: 127.145, category: "ì¼ì‹", address: "ì „ì£¼ì‹œ ì™„ì‚°êµ¬ ì „ë¼ê°ì˜ë¡œ 67", jibun: "ì¤‘ì•™ë™ 67-2" },
            { r_name: "íŒŒìŠ¤íƒ€ & ìŠ¤í…Œì´í¬", y: 35.822, x: 127.152, category: "ì–‘ì‹", address: "ì „ì£¼ì‹œ ì™„ì‚°êµ¬ ì„œë…¸ì†¡ë™ 89", jibun: "ì„œë…¸ì†¡ë™ 89-4" },
        ];
        
        return dummyData.map(r => ({ 
            name: r.r_name, 
            lat: r.y, 
            lon: r.x, 
            category: r.category, 
            address: r.address, 
            jibun: r.jibun 
        }));
        
    } catch(e) { console.error(e); return []; }
}

// âš ï¸ ìˆ˜ì •: ì§€ë„ ë Œë”ë§ ë° ëª©ë¡ í‘œì‹œ ë¡œì§ ë³€ê²½
function renderMap(lat, lon, restaurants, isUserLocation){
    const center = new kakao.maps.LatLng(lat, lon);
    if(!map){ map = new kakao.maps.Map(document.getElementById('map'), {center, level:4}); }
    else map.setCenter(center);
    markers.forEach(m=>m.setMap(null));
    markers=[];

    // ì§€ë„ ìƒ ë‚´ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ (ê¸°ì¡´ê³¼ ë™ì¼)
    if(isUserLocation){
        const userMarker = new kakao.maps.Marker({position:center,map});
        const info = new kakao.maps.InfoWindow({ content:"<div style='padding:5px;'>ğŸ“ ë‚´ ìœ„ì¹˜</div>" });
        info.open(map,userMarker); markers.push(userMarker);
    }
    
    const listContainer = document.getElementById("foodList");
    // ğŸ’¡ ë³€ê²½: UL ëŒ€ì‹  OL íƒœê·¸ë¥¼ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ìˆœì„œ ìˆëŠ” ë¦¬ìŠ¤íŠ¸ë¡œ ë³€ê²½
    const ol = document.createElement("ol");
    listContainer.innerHTML=""; // ê¸°ì¡´ ul ë‚´ìš©ì„ ë¹„ìš°ê³ 
    listContainer.appendChild(ol); // olì„ ì¶”ê°€

    restaurants.forEach(r=>{
        const pos = new kakao.maps.LatLng(r.lat, r.lon);
        const marker = new kakao.maps.Marker({position:pos,map});
        markers.push(marker);

        // íŒì—… ì˜¤ë²„ë ˆì´(InfoWindow) ë‚´ìš© ìƒì„±
        const infoContent = `<div style="padding:5px; font-size:12px; line-height:1.5;">
            <strong>${r.name}</strong> (${r.category})<br>
            ë„ë¡œëª…: ${r.address}<br>
            ì§€ë²ˆ: ${r.jibun}
        </div>`;
        const info = new kakao.maps.InfoWindow({ content:infoContent });
        
        // ì§€ë„ ë§ˆì»¤ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°/ë‹«ê¸°
        kakao.maps.event.addListener(marker,'click',()=>{ 
            info.setMap(map); // í•­ìƒ ë³´ì´ê²Œ í•˜ë ¤ë©´ open() ëŒ€ì‹  setMap()
            info.setPosition(pos); 
        });
        
        // ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ë° íŒì˜¤ë²„ ê¸°ëŠ¥ ì¶”ê°€
        const li = document.createElement("li");
        li.style.cursor = "pointer"; // í´ë¦­ ê°€ëŠ¥í•¨ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤Œ

        // ìŒì‹ì  ì´ë¦„ê³¼ ì†Œë¶„ë¥˜ í‘œì‹œ
        li.innerHTML = `<strong>${r.name}</strong> <span style="font-size: small; color: #888;">(${r.category})</span>`;
        ol.appendChild(li); // UL ëŒ€ì‹  OLì— ì¶”ê°€

        // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œì—ë„ ì§€ë„ ë§ˆì»¤ì˜ íŒì—…(InfoWindow) ì—´ê¸°
        li.onclick = () => {
            // ì§€ë„ ì´ë™ ë° ë ˆë²¨ ì¡°ì •
            map.setCenter(pos); 
            map.setLevel(3, {animate: {duration: 500}});

            // ëª¨ë“  íŒì—… ë‹«ê¸° (ì„ íƒëœ ìŒì‹ì ë§Œ ë³´ì´ë„ë¡)
            markers.forEach(m => kakao.maps.event.addListener(m, 'click', null)); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ëŠ” ë³µì¡í•˜ë‹ˆ ê°„ë‹¨íˆ
            
            info.open(map, marker);
        };
    });
    document.getElementById("listCard").style.display="block";
}


// (ë¹„ë™ê¸°ì‹ í•¨ìˆ˜) GEO ì‘ë™í›„ ë¡œì§ ì‹¤í–‰ (ê¸°ì¡´ê³¼ ë™ì¼)
async function loadAll(lat, lon, isUserLocation){
    try{
        if(lat===undefined||lon===undefined){
            const pos=await getUserLocation();
            lat=pos.lat; lon=pos.lon; isUserLocation=true;
        }
        const weather=await loadWeather(lat,lon);
        document.getElementById("temp").textContent=weather.temp;
        document.getElementById("cloud").textContent=weather.cloud;
        document.getElementById("rain").textContent=weather.rain;
        document.getElementById("humidity").textContent=weather.humidity;
        document.getElementById("weatherCard").style.display="block";
        const food=recommendFood(weather);
        document.getElementById("foodText").textContent=food;
        document.getElementById("foodCard").style.display="block";
        const restaurants=await loadRestaurants(lat,lon);
        renderMap(lat,lon,restaurants,isUserLocation);
    } catch(e){ alert("ì˜¤ë¥˜: "+e); }
}


window.addEventListener("DOMContentLoaded", async ()=>{
    try{
        const pos=await getUserLocation();
        const isUserLocation=!(pos.lat===35.8242&&pos.lon===127.1480);
        loadAll(pos.lat,pos.lon,isUserLocation);
    }catch(e){ loadAll(35.8242,127.1480,false); }
});

// GEOlocationì—ì„œ ë°›ì•„ì˜¨ ê°’ ê¸°ìƒì²­apië¡œ ë³´ë‚´ì£¼ê¸° ìœ„í•œ ì£„í‘œ ê³„ì‚° ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
function dfsXyConv(lat, lon){
    const RE=6371.00877, GRID=5.0, SLAT1=30.0, SLAT2=60.0, OLON=126.0, OLAT=38.0, XO=43, YO=136, DEGRAD=Math.PI/180;
    let re=RE/GRID, slat1=SLAT1*DEGRAD, slat2=SLAT2*DEGRAD, olon=OLON*DEGRAD, olat=OLAT*DEGRAD;
    let sn=Math.tan(Math.PI*0.25+slat2*0.5)/Math.tan(Math.PI*0.25+slat1*0.5);
    sn=Math.log(Math.cos(slat1)/Math.cos(slat2))/Math.log(sn);
    let sf=Math.tan(Math.PI*0.25+slat1*0.5); sf=Math.pow(sf,sn)*Math.cos(slat1)/sn;
    let ro=Math.tan(Math.PI*0.25+olat*0.5); ro=re*sf/Math.pow(ro,sn);
    let ra=Math.tan(Math.PI*0.25+lat*DEGRAD*0.5); ra=re*sf/Math.pow(ra,sn);
    let theta=lon*DEGRAD-olon; if(theta>Math.PI) theta-=2*Math.PI; if(theta<-Math.PI) theta+=2*Math.PI; theta*=sn;
    return { x:Math.floor(ra*Math.sin(theta)+XO+0.5), y:Math.floor(ro-ra*Math.cos(theta)+YO+0.5) };
}

// ë‚ ì”¨, ì˜¨ë„ì— ë”°ë¼ì„œ svg íŒŒì¼ ë³€ê²½ (ê¸°ì¡´ê³¼ ë™ì¼)
function getWeatherIcon(pty, sky, cloud, rain){
    switch(pty){
        case 1: return "icons/rain.svg";
        case 2: return "icons/sleet.svg";
        case 3: return "icons/snow.svg";
        case 4: return "icons/shower.svg";
        case 5: return "icons/drizzle.svg";
        case 6: return "icons/sleet.svg";
        case 7: return "icons/flurry.svg";
    }
    if(cloud>80) return rain>0?"icons/thunder-rain.svg":"icons/cloud.svg";
    if(cloud>50) return "icons/partly.svg";
    return "icons/sun.svg";
}



//=======================================================================================
// í”Œë¡œíŒ… íŒ¨ë„ flotmenu
const foodCategories = [
        "ë°±ë°˜/í•œì •ì‹", "ì¤‘êµ­ì§‘", "êµ­ìˆ˜", "ë¼ì§€ê³ ê¸°", "ë¶„ì‹",
        "ì†Œê³ ê¸°", "ì¹˜í‚¨", "í”¼ì", "ì¡±ë°œÂ·ë³´ìŒˆ",
        "ë””ì €íŠ¸", "ê²½ì–‘ì‹", "ê³±ì°½",
        "í•´ì‚°ë¬¼", "êµ¬ë‚´ì‹ë‹¹", "êµ­ë°¥", "ë¼ë©´"
    ];

    function closePanel() {
        const panel = document.getElementById('floatingPanel');
        panel.style.opacity = '0';
        setTimeout(() => panel.style.display = 'none', 300);
    }

    // 10ê°œ ëœë¤ ìŒì‹ í‘œì‹œ
    function renderRandomFoods() {
        const randomFoods = [...foodCategories]
            .sort(() => Math.random() - 0.5)
            .slice(0, 10);

        const listContainer = document.getElementById("flotmenu");
        listContainer.innerHTML = randomFoods
            .map(item => `<div class="food-item">${item}</div>`)
            .join("");
    }

    renderRandomFoods();
//=======================================================================================

</script>
</body>
</html>
