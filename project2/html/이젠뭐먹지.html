<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‚ ì”¨ ê¸°ë°˜ ìŒì‹ ì¶”ì²œ & ì§€ë„ (SPA)</title>

<!-- Kakao Maps API -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey="></script>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="layout">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œ -->
    <div class="sidebar">

        <!-- íƒ€ì´í‹€  -->
        <h2><img src="icons/emoji.png" height="30px" width="30px"> EZEN ë­ ë¨¹ì§€?</h2>

        <!-- ê²€ìƒ‰ ì…ë ¥ -->
        <input id="locationInput" name="locationInput" placeholder="ì˜ˆ: OOë™ or ìŒì‹ì  ì´ë¦„">

        <!-- ë²„íŠ¼ëˆ„ë¥´ë©´ loadAllí•¨ìˆ˜ ì‹¤í–‰ -->
        <button onclick="loadAll()">ì¡°íšŒí•˜ê¸°</button>

        <!-- ë‚ ì”¨ ì˜ì—­ -->
        <div id="weatherCard" class="weather-card" style="display:none;">

            <img class="weather-bg-icon" id="weatherBgIcon" src="icons/sun.png">
            <h3>í˜„ì¬ ë‚ ì”¨</h3>
            <div class="weather-main">
                <img id="weatherIcon" class="weather-icon" src="icons/sun.png">
                <div class="temp"><span id="temp"></span>Â°C</div>
            </div>

            <!-- ê¸°ìƒì²­apiì—ì„œ ë°›ì•„ì˜¨ ê°’ ì¶œë ¥ -->
            <div class="weather-details">
                <div class="weather-detail">
                    <span id="cloud"></span>%<small>êµ¬ë¦„ëŸ‰</small>
                </div>
                <div class="weather-detail">
                    <span id="rain"></span>mm<small>ê°•ìˆ˜ëŸ‰</small>
                </div>
                <div class="weather-detail">
                    <span id="humidity"></span>%<small>ìŠµë„</small>
                </div>
            </div>
        </div>
    <!-- ì¶”ì²œ ìŒì‹ ì¹´ë“œ -->
        <div id="foodCard" class="card" style="display:none;">
            <div class="title-small">ğŸœ ì¶”ì²œ ìŒì‹</div>
            <p id="foodText"></p>
        </div>
    <!-- ì¶”ì²œ ìŒì‹ì  ëª©ë¡ -->
        <div id="listCard" class="card" style="display:none;">
            <div class="title-small">ğŸ½ ì£¼ë³€ ìŒì‹ì </div>
            <ul id="foodList"></ul>
        </div>
    </div>
    <!-- ì˜¤ë¥¸ìª½ ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>
</div>

<script>
let map;
let markers = [];

// ì‚¬ìš©ì ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
async function getUserLocation() {
    return new Promise((resolve) => {
        // ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ë©´ ì „ì£¼ ì‹œì²­ìœ¼ë¡œ ê¸°ë³¸ê°’ ì§€ì •
        if (!navigator.geolocation) resolve({lat:35.8242, lon:127.1480});
        // ê±°ë¶€í•˜ë©´ ì „ì£¼ì‹œì²­ìœ¼ë¡œ ê¸°ë³¸ê°’ ì§€ì •
        else navigator.geolocation.getCurrentPosition(
            pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
            err => resolve({lat:35.8242, lon:127.1480})
        );
    });
}

// ê¸°ìƒì²­ì—ì„œ ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadWeather(lat, lon) {
    const { x: nx, y: ny } = dfsXyConv(lat, lon);
    const now = new Date();
    let baseDate = new Date(now);
    let hh = now.getHours();
    let mm = now.getMinutes();
    if (mm < 40) { hh -= 1; if(hh<0){ hh=23; baseDate.setDate(baseDate.getDate()-1); } }
    const baseDateStr = baseDate.toISOString().slice(0,10).replace(/-/g,"");
    const baseTime = String(hh).padStart(2,"0") + "00";
    const serviceKey = "REMOVED";  // api key
    const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getUltraSrtNcst?serviceKey=${serviceKey}&numOfRows=100&pageNo=1&dataType=JSON&base_date=${baseDateStr}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        const items = data.response.body.items.item;
        let weather={ temp:"-", cloud:"-", rain:"-", humidity:"-", pty:0, sky:1 };
        items.forEach(it => { switch(it.category){
            case "T1H": weather.temp=it.obsrValue; break;
            case "RN1": weather.rain=it.obsrValue; break;
            case "REH": weather.humidity=it.obsrValue; break;
            case "SKY": weather.sky=it.obsrValue; break;
            case "PTY": weather.pty=it.obsrValue; break;
        }});
        if(weather.sky!="-") weather.cloud=(weather.sky/4*100).toFixed(0);
        const iconName = getWeatherIcon(weather.pty, weather.sky, weather.cloud, weather.rain);
        document.getElementById("weatherIcon").src = iconName;
        document.getElementById("weatherBgIcon").src = iconName;
        return weather;
    } catch(e) { console.error(e); return { temp:"-", cloud:"-", rain:"-", humidity:"-" }; }
}

// ê°„ë‹¨ ìŒì‹ ì¶”ì²œ
function recommendFood(w){
    if(w.temp<10) return "ë”°ëœ»í•œ êµ­ë¬¼ ìš”ë¦¬: ì „ê³¨, ë¼ë©˜, ìš°ë™";
    if(w.rain>1) return "ë¹„ ì˜¤ëŠ” ë‚ ì—” íŒŒì „ + ë§‰ê±¸ë¦¬!";
    if(w.cloud>70) return "ë“ ë“ í•œ ìŒì‹: ì¹´ë ˆ, ì°œë‹­";
    return "ê°€ë³ê³  ì‚°ëœ»í•œ ìŒì‹: ì´ˆë°¥, ìƒëŸ¬ë“œ";
}

async function loadRestaurants(lat, lon){
    try{
        const res = await fetch("http://127.0.0.1:5000/restaurants");
        const data = await res.json();
        return data.map(r => ({ name:r.r_name, lat:r.y, lon:r.x }));
    } catch(e) { console.error(e); return []; }
}

// ì¹´ì¹´ì˜¤ ë§µ ì§€ë„ ë Œë”ë§
function renderMap(lat, lon, restaurants, isUserLocation){
    const center = new kakao.maps.LatLng(lat, lon);
    if(!map){ map = new kakao.maps.Map(document.getElementById('map'), {center, level:4}); }
    else map.setCenter(center);
    markers.forEach(m=>m.setMap(null));
    markers=[];
    if(isUserLocation){
        const userMarker = new kakao.maps.Marker({position:center,map});
        const info = new kakao.maps.InfoWindow({ content:"<div style='padding:5px;'>ğŸ“ ë‚´ ìœ„ì¹˜</div>" });
        info.open(map,userMarker); markers.push(userMarker);
    }
    const ul = document.getElementById("foodList");
    ul.innerHTML="";
    restaurants.forEach(r=>{
        const pos = new kakao.maps.LatLng(r.lat, r.lon);
        const marker = new kakao.maps.Marker({position:pos,map});
        const info = new kakao.maps.InfoWindow({ content:`<div style='padding:5px;'>${r.name}</div>` });
        kakao.maps.event.addListener(marker,'click',()=>{info.open(map,marker);});
        markers.push(marker);

        // ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        const li = document.createElement("li");
        li.textContent = r.name;
        ul.appendChild(li);
    });
    document.getElementById("listCard").style.display="block";
}

// (ë¹„ë™ê¸°ì‹ í•¨ìˆ˜) GEO ì‘ë™í›„ ë¡œì§ ì‹¤í–‰
async function loadAll(lat, lon, isUserLocation){
    try{
        if(lat===undefined||lon===undefined){
            const pos=await getUserLocation();
            lat=pos.lat; lon=pos.lon; isUserLocation=true;
        }
        const weather=await loadWeather(lat,lon);
        document.getElementById("temp").textContent=weather.temp;
        document.getElementById("cloud").textContent=weather.cloud;
        document.getElementById("rain").textContent=weather.rain;
        document.getElementById("humidity").textContent=weather.humidity;
        document.getElementById("weatherCard").style.display="block";
        const food=recommendFood(weather);
        document.getElementById("foodText").textContent=food;
        document.getElementById("foodCard").style.display="block";
        const restaurants=await loadRestaurants(lat,lon);
        renderMap(lat,lon,restaurants,isUserLocation);
    } catch(e){ alert("ì˜¤ë¥˜: "+e); }
}


window.addEventListener("DOMContentLoaded", async ()=>{
    try{
        const pos=await getUserLocation();
        const isUserLocation=!(pos.lat===35.8242&&pos.lon===127.1480);
        loadAll(pos.lat,pos.lon,isUserLocation);
    }catch(e){ loadAll(35.8242,127.1480,false); }
});

// GEOlocationì—ì„œ ë°›ì•„ì˜¨ ê°’ ê¸°ìƒì²­apië¡œ ë³´ë‚´ì£¼ê¸° ìœ„í•œ ì£„í‘œ ê³„ì‚° ë¡œì§
function dfsXyConv(lat, lon){
    const RE=6371.00877, GRID=5.0, SLAT1=30.0, SLAT2=60.0, OLON=126.0, OLAT=38.0, XO=43, YO=136, DEGRAD=Math.PI/180;
    let re=RE/GRID, slat1=SLAT1*DEGRAD, slat2=SLAT2*DEGRAD, olon=OLON*DEGRAD, olat=OLAT*DEGRAD;
    let sn=Math.tan(Math.PI*0.25+slat2*0.5)/Math.tan(Math.PI*0.25+slat1*0.5);
    sn=Math.log(Math.cos(slat1)/Math.cos(slat2))/Math.log(sn);
    let sf=Math.tan(Math.PI*0.25+slat1*0.5); sf=Math.pow(sf,sn)*Math.cos(slat1)/sn;
    let ro=Math.tan(Math.PI*0.25+olat*0.5); ro=re*sf/Math.pow(ro,sn);
    let ra=Math.tan(Math.PI*0.25+lat*DEGRAD*0.5); ra=re*sf/Math.pow(ra,sn);
    let theta=lon*DEGRAD-olon; if(theta>Math.PI) theta-=2*Math.PI; if(theta<-Math.PI) theta+=2*Math.PI; theta*=sn;
    return { x:Math.floor(ra*Math.sin(theta)+XO+0.5), y:Math.floor(ro-ra*Math.cos(theta)+YO+0.5) };
}

// ë‚ ì”¨, ì˜¨ë„ì— ë”°ë¼ì„œ svg íŒŒì¼ ë³€ê²½
function getWeatherIcon(pty, sky, cloud, rain){
    switch(pty){
        case 1: return "icons/rain.svg";
        case 2: return "icons/sleet.svg";
        case 3: return "icons/snow.svg";
        case 4: return "icons/shower.svg";
        case 5: return "icons/drizzle.svg";
        case 6: return "icons/sleet.svg";
        case 7: return "icons/flurry.svg";
    }
    if(cloud>80) return rain>0?"icons/thunder-rain.svg":"icons/cloud.svg";
    if(cloud>50) return "icons/partly.svg";
    return "icons/sun.svg";
}
</script>
</body>
</html>
